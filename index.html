<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>防红链接生成器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="color-scheme" content="dark">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/iosxlb/static@main/favicon/link.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    /* 添加自定义样式 */
    .fixed-position {
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow-y: scroll;
    }

    .btn-gradient {
      background: linear-gradient(135deg, #2563eb, #10b981);
    }

    .btn-gradient-secondary {
      background: linear-gradient(135deg, #ef4444, #f59e0b);
    }

    .card-shadow {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card-shadow-hover {
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
    }

    .glow {
      box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
    }

    .selected {
      border: 2px solid #2563eb;
    }
  </style>
</head>
<body class="bg-gray-800 text-white min-h-screen flex items-center justify-center px-2 py-6 font-sans">
  <div class="container max-w-md w-full bg-gray-900 rounded-3xl card-shadow transition-all duration-300 hover:card-shadow-hover overflow-hidden backdrop-blur-2xl">
    <!-- 顶部装饰 -->
    <div class="h-1 bg-gradient-to-r from-primary to-blue-400"></div>
    <!-- Logo与标题 -->
    <div class="flex justify-center mt-5">
      <div class="w-14 h-14 flex items-center justify-center rounded-full bg-primary shadow-lg text-white text-2xl glow">
        <i class="fa fa-link"></i>
      </div>
    </div>
    <div class="text-center pt-2 pb-1 px-5">
      <h1 class="text-2xl md:text-2xl font-extrabold text-primary drop-shadow-sm tracking-wide mb-2">防红链接生成器</h1>
      <p class="text-gray-400 text-sm mb-2">安全转换 · 稳定防红 · 支持HTTP/HTTPS</p>
    </div>
    <!-- 输入区域 -->
    <div class="p-4 pt-2 mx-3">
      <label for="targetUrl" class="block text-gray-400 font-medium mb-2 text-sm">
        <i class="fa fa-globe mr-1"></i> 目标网址
      </label>
      <div class="relative">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
          <i class="fa fa-link"></i>
        </span>
        <input 
          type="text" 
          id="targetUrl" 
          placeholder="http://或https://需要防红的网址.com" 
          class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-200 text-sm bg-gray-700"
          autocomplete="off"
        >
      </div>
      <!-- 颜色选择器 -->
      <div class="mt-4">
        <span class="text-xs text-gray-400 font-medium mb-1 block">二维码颜色：</span>
        <div class="flex flex-wrap gap-2">
          <input type="radio" name="qrcolor" id="qrcolor1" class="hidden color-radio" value="#2563eb" checked>
          <label for="qrcolor1" class="w-7 h-7 rounded-full border-2 border-gray-600 flex items-center justify-center cursor-pointer" style="background:#2563eb"></label>
          <input type="radio" name="qrcolor" id="qrcolor2" class="hidden color-radio" value="#10b981">
          <label for="qrcolor2" class="w-7 h-7 rounded-full border-2 border-gray-600 flex items-center justify-center cursor-pointer" style="background:#10b981"></label>
          <input type="radio" name="qrcolor" id="qrcolor3" class="hidden color-radio" value="#ef4444">
          <label for="qrcolor3" class="w-7 h-7 rounded-full border-2 border-gray-600 flex items-center justify-center cursor-pointer" style="background:#ef4444"></label>
          <input type="radio" name="qrcolor" id="qrcolor4" class="hidden color-radio" value="#f59e0b">
          <label for="qrcolor4" class="w-7 h-7 rounded-full border-2 border-gray-600 flex items-center justify-center cursor-pointer" style="background:#f59e0b"></label>
          <input type="radio" name="qrcolor" id="qrcolor5" class="hidden color-radio" value="#000000">
          <label for="qrcolor5" class="w-7 h-7 rounded-full border-2 border-gray-600 flex items-center justify-center cursor-pointer" style="background:#000000"></label>
        </div>
      </div>
      <!-- 链接有效期设置 -->
      <div class="mt-4">
        <label for="linkExpiry" class="block text-gray-400 font-medium mb-2 text-sm">
          <i class="fa fa-clock-o mr-1"></i> 链接有效期
        </label>
        <div class="flex flex-wrap gap-2">
          <input type="radio" name="expiry" id="expiryPermanent" class="hidden" value="permanent" checked>
          <label for="expiryPermanent" class="cursor-pointer text-sm text-gray-400 hover:text-primary transition-all duration-200 selected">永久有效</label>
          <input type="radio" name="expiry" id="expiry7Days" class="hidden" value="7">
          <label for="expiry7Days" class="cursor-pointer text-sm text-gray-400 hover:text-primary transition-all duration-200">7天</label>
          <input type="radio" name="expiry" id="expiry1Day" class="hidden" value="1">
          <label for="expiry1Day" class="cursor-pointer text-sm text-gray-400 hover:text-primary transition-all duration-200">1天</label>
          <input type="radio" name="expiry" id="expiry3Hours" class="hidden" value="0.125">
          <label for="expiry3Hours" class="cursor-pointer text-sm text-gray-400 hover:text-primary transition-all duration-200">3小时</label>
        </div>
      </div>
      <!-- 生成按钮 -->
      <button 
        class="btn-gradient w-full py-3 rounded-lg text-white font-semibold mt-4 shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 text-base"
        onclick="generate()"
        id="generateBtn"
      >
        <i class="fa fa-magic mr-2"></i> 生成防红链接
      </button>
    </div>
    <!-- 结果区域 -->
    <div id="result" class="hidden p-4 mx-3 mt-2 animate-fadeIn">
      <div class="bg-gray-800 border-l-4 border-primary p-4 rounded-lg mb-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-400 font-semibold text-xs">防红链接</span>
          <span class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full">已防红</span>
        </div>
        <div id="output" class="text-sm text-blue-300 break-all select-all relative font-mono py-2 px-2 rounded bg-gray-700">
          <!-- 链接将在这里生成 -->
        </div>
        <button 
          class="btn-gradient-secondary w-full py-2.5 rounded-lg text-white font-medium mt-3 shadow hover:shadow-lg transition-all duration-300 text-base"
          onclick="copyResult()"
        >
          <i class="fa fa-clipboard mr-2"></i> 一键复制链接
        </button>
      </div>
      <!-- 二维码区域 -->
      <div class="text-center pt-2">
        <h3 class="text-gray-400 font-medium text-xs mb-2 tracking-wide">
          <i class="fa fa-qrcode mr-1"></i> 手机扫码访问
        </h3>
        <div id="qrcode" class="mx-auto p-3 bg-gray-700 rounded-lg shadow w-max"></div>
        <p class="text-xs text-gray-400 mt-2">长按二维码可保存图片</p>
      </div>
      <!-- 链接有效期显示 -->
      <div class="mt-4">
        <label for="linkExpiryDisplay" class="block text-gray-400 font-medium mb-2 text-sm">
          <i class="fa fa-clock-o mr-1"></i> 链接有效期
        </label>
        <div id="linkExpiryDisplay" class="text-sm text-gray-400 break-all select-all relative font-mono py-2 px-2 rounded bg-gray-700">
          <!-- 链接有效期将在这里显示 -->
        </div>
      </div>
    </div>
    <!-- 查看链接区域 -->
    <div id="viewLink" class="hidden p-4 mx-3 mt-2 animate-fadeIn">
      <div class="bg-gray-800 border-l-4 border-primary p-4 rounded-lg mb-4">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-400 font-semibold text-xs">查看链接</span>
          <span class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full">已防红</span>
        </div>
        <div id="viewOutput" class="text-sm text-blue-300 break-all select-all relative font-mono py-2 px-2 rounded bg-gray-700">
          <!-- 查看链接将在这里显示 -->
        </div>
        <div id="remainingTime" class="text-sm text-gray-400 mt-2">
          <!-- 剩余时间将在这里显示 -->
        </div>
      </div>
    </div>
  </div>
  <script>
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 防止输入框聚焦时页面滚动
      const inputFields = document.querySelectorAll('input, textarea');
      let initialScrollY = 0;
      
      inputFields.forEach(input => {
        input.addEventListener('focus', function() {
          initialScrollY = window.scrollY;
          // 防止iOS Safari在输入框聚焦时调整视口
          document.body.classList.add('fixed-position');
          document.body.style.top = `-${initialScrollY}px`;
        });
        
        input.addEventListener('blur', function() {
          document.body.classList.remove('fixed-position');
          window.scrollTo(0, initialScrollY);
        });
      });
      
      // 阻止双击缩放
      document.addEventListener('touchstart', function(event) {
        if (event.touches.length > 1) {
          event.preventDefault();
        }
      }, { passive: false });
      
      // 阻止双指缩放
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });
    });

    // Base64编码函数
    function base64Encode(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    // 生成防红链接
    function generate() {
      var url = document.getElementById('targetUrl').value.trim();
      var expiry = document.querySelector('input[name="expiry"]:checked').value;
      var btn = document.getElementById('generateBtn');
      var qrcolor = document.querySelector('input[name="qrcolor"]:checked').value || "#2563eb";

      if (!url) {
        showToast('请输入目标网址！', 'error');
        return;
      }

      if (!/^https?:\/\//i.test(url)) {
        showToast('仅支持以 http:// 或 https:// 开头的链接！', 'error');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 生成中...';

      setTimeout(() => {
        var encodedUrl = base64Encode(url);
        var currentOrigin = window.location.origin;
        var currentPath = window.location.pathname.split('/').slice(0, -1).join('/');
        var resultUrl = `${currentOrigin}${currentPath}/ink.htm?c=${encodedUrl}&expiry=${expiry}`;

        document.getElementById('output').textContent = resultUrl;
        document.getElementById('result').classList.remove('hidden');

        var qrcodeDiv = document.getElementById('qrcode');
        qrcodeDiv.innerHTML = "";
        new QRCode(qrcodeDiv, {
          text: resultUrl,
          width: Math.min(180, window.innerWidth * 0.65),
          height: Math.min(180, window.innerWidth * 0.65),
          colorDark: qrcolor,
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });

        btn.disabled = false;
        btn.innerHTML = '<i class="fa fa-magic mr-2"></i> 生成防红链接';
        showToast('防红链接生成成功！', 'success');

        // 存储链接生成时间
        const now = new Date();
        localStorage.setItem('linkGeneratedTime', now.toISOString());

        // 显示链接有效期
        document.getElementById('linkExpiryDisplay').textContent = `链接有效期：${getExpiryText(expiry)}`;
      }, 700);
    }

    // 获取链接有效期文本
    function getExpiryText(expiry) {
      if (expiry === 'permanent') {
        return '永久有效';
      } else {
        return `${expiry}天后过期`;
      }
    }

    // 复制结果到剪贴板
    function copyResult() {
      var text = document.getElementById('output').textContent;
      if (!text) {
        showToast('没有可复制的链接！', 'error');
        return;
      }

      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('链接已复制！', 'success');
        }).catch(err => {
          showToast('复制失败：' + err, 'error');
        });
      } else {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          showToast('链接已复制！', 'success');
        } catch (err) {
          showToast('复制失败，请手动复制', 'error');
        }
        document.body.removeChild(textarea);
      }
    }

    // Toast 提示
    function showToast(message, type = 'info') {
      var toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'fixed bottom-8 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50 text-white font-medium text-sm animate-fadeIn';
      toast.style.background = type === 'success' ? '#10b981' : (type === 'error' ? '#ef4444' : '#2563eb');
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 2200);
    }

    // 计算剩余时间
    function calculateRemainingTime() {
      const urlParams = new URLSearchParams(window.location.search);
      const expiryParam = urlParams.get('expiry');

      if (!expiryParam) {
        console.error('链接中没有有效期参数');
        return;
      }

      const expiry = expiryParam === 'permanent' ? '永久有效' : parseFloat(expiryParam);
      const linkGeneratedTime = localStorage.getItem('linkGeneratedTime');

      if (!linkGeneratedTime) {
        console.error('未找到链接生成时间');
        return;
      }

      const now = new Date();
      const generatedTime = new Date(linkGeneratedTime);

      if (expiry === '永久有效') {
        document.getElementById('remainingTime').textContent = '链接永久有效';
        return;
      }

      const expiryTime = new Date(generatedTime.getTime() + expiry * 24 * 60 * 60 * 1000);
      const remainingTime = expiryTime - now;

      if (remainingTime <= 0) {
        document.getElementById('remainingTime').textContent = '链接已过期';
      } else {
        const days = Math.floor(remainingTime / (24 * 60 * 60 * 1000));
        const hours = Math.floor((remainingTime % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
        const minutes = Math.floor((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
        const seconds = Math.floor((remainingTime % (60 * 1000)) / 1000);

        document.getElementById('remainingTime').textContent = `链接剩余有效时间：${days}天 ${hours}小时 ${minutes}分钟 ${seconds}秒`;
      }
    }

    // 查看链接
    function viewLink() {
      const urlParams = new URLSearchParams(window.location.search);
      const encodedUrl = urlParams.get('c');
      const expiryParam = urlParams.get('expiry');

      if (!encodedUrl) {
        console.error('链接中没有目标网址参数');
        return;
      }

      const decodedUrl = atob(encodedUrl);
      document.getElementById('viewOutput').textContent = decodedUrl;

      calculateRemainingTime();

      document.getElementById('viewLink').classList.remove('hidden');
    }

    // 在页面加载时调用
    window.onload = () => {
      viewLink();
    };

    // 添加事件监听器以处理选择链接有效期和二维码颜色
    document.querySelectorAll('input[name="expiry"], input[name="qrcolor"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.querySelectorAll('label[for^="expiry"], label[for^="qrcolor"]').forEach(label => {
          label.classList.remove('selected');
        });
        this.nextElementSibling.classList.add('selected');
      });
    });
  </script>
</body>
</html>
